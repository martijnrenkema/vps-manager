{% extends "base.html" %}
{% from "icons.html" import icon %}
{% block title %}SSL - VPS Manager{% endblock %}
{% block page_title %}SSL Certificates{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header" style="justify-content:space-between">
        <span>{{ icon('lock') }} Let's Encrypt Certificates</span>
        <button class="btn btn-sm btn-green" onclick="showConfirm('SSL Renewal', 'Force renew all certificates?', renewAll)">{{ icon('refresh') }} Renew All</button>
    </div>
    <div class="card-body">
        {% if certs %}
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Domain(s)</th>
                        <th>Expires</th>
                        <th>Days</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cert in certs %}
                    <tr>
                        <td>{{ cert.domain }}</td>
                        <td>{{ cert.expiry }}</td>
                        <td>{{ cert.days_left }}</td>
                        <td>
                            {% if cert.days_left > 30 %}
                                <span class="badge badge-green">OK</span>
                            {% elif cert.days_left > 7 %}
                                <span class="badge badge-yellow">Expiring soon</span>
                            {% else %}
                                <span class="badge badge-red">Critical!</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm" onclick="renewCert({{ cert.domain.split(' ')[0] | tojson }})">Renew</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">Unable to retrieve SSL certificates.</div>
        {% endif %}
    </div>
</div>

<div id="renewOutput" style="display:none;margin-top:16px">
    <div class="card">
        <div class="card-header">{{ icon('terminal') }} Renewal output</div>
        <div class="card-body"><pre id="renewLog">Renewing...</pre></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function renewCert(domain) {
    document.getElementById('renewOutput').style.display = 'block';
    document.getElementById('renewLog').textContent = 'Renewing ' + domain + '...';
    try {
        var res = await fetch('/ssl/renew', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({domain: domain})
        });
        var data = await res.json();
        document.getElementById('renewLog').textContent = data.output || data.message || 'Done.';
        showToast(res.ok ? 'Renewal successful' : 'Renewal failed', res.ok ? 'success' : 'error');
    } catch (e) {
        document.getElementById('renewLog').textContent = 'Connection error';
        showToast('Connection error', 'error');
    }
    setTimeout(function() { location.reload(); }, 3000);
}

async function renewAll() {
    document.getElementById('renewOutput').style.display = 'block';
    document.getElementById('renewLog').textContent = 'Renewing all certificates...';
    try {
        var res = await fetch('/ssl/renew', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({})
        });
        var data = await res.json();
        document.getElementById('renewLog').textContent = data.output || data.message || 'Done.';
        showToast(res.ok ? 'Renewal successful' : 'Renewal failed', res.ok ? 'success' : 'error');
    } catch (e) {
        document.getElementById('renewLog').textContent = 'Connection error';
        showToast('Connection error', 'error');
    }
    setTimeout(function() { location.reload(); }, 3000);
}
</script>
{% endblock %}
