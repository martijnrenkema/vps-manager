{% extends "base.html" %}
{% from "icons.html" import icon %}
{% block title %}Settings - VPS Manager{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<!-- Password Change -->
<div class="card">
    <div class="card-header">{{ icon('lock') }} Change Password</div>
    <div class="card-body">
        <form id="passwordForm" onsubmit="changePassword(event)" style="max-width:400px">
            <div class="form-group">
                <label for="current_password">Current password</label>
                <input type="password" id="current_password" class="form-control" autocomplete="current-password" required>
            </div>
            <div class="form-group">
                <label for="new_password">New password (min. 8 characters)</label>
                <input type="password" id="new_password" class="form-control" autocomplete="new-password" minlength="8" required>
            </div>
            <div class="form-group">
                <label for="confirm_password">Confirm new password</label>
                <input type="password" id="confirm_password" class="form-control" autocomplete="new-password" required>
            </div>
            <button type="submit" class="btn btn-green">Save Password</button>
        </form>
    </div>
</div>

<!-- 2FA -->
<div class="card">
    <div class="card-header">{{ icon('shield') }} Two-Factor Authentication</div>
    <div class="card-body">
        {% if not has_2fa %}
        <div class="alert alert-danger">
            <code>pyotp</code> and <code>qrcode</code> are not installed. Install them with: <code>pip install pyotp qrcode[pil]</code>
        </div>
        {% else %}
        <div style="margin-bottom:16px">
            <span class="badge {% if config.auth.totp_secret %}badge-green{% else %}badge-yellow{% endif %}" style="font-size:13px;padding:6px 12px">
                2FA is {% if config.auth.totp_secret %}enabled{% else %}disabled{% endif %}
            </span>
        </div>

        {% if not config.auth.totp_secret %}
        <button class="btn btn-green" onclick="enable2FA()">Enable 2FA</button>

        <div id="setup2fa" style="display:none;margin-top:20px">
            <p style="color:var(--text-secondary);font-size:14px;margin-bottom:12px">
                Scan the QR code with your authenticator app (Google Authenticator, Authy, etc.)
            </p>
            <div id="qrCodeContainer" style="margin-bottom:16px"></div>
            <div style="margin-bottom:16px">
                <label style="font-size:12px;color:var(--text-muted)">Manual key:</label>
                <code id="totpSecret" style="display:block;margin-top:4px;font-size:14px;word-break:break-all"></code>
            </div>
            <div class="form-group" style="max-width:200px">
                <label for="verify_code">Enter 6-digit code to verify</label>
                <input type="text" id="verify_code" class="form-control" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" placeholder="000000" required>
            </div>
            <button class="btn btn-green" onclick="verify2FA()">Verify & Enable</button>
        </div>
        {% else %}
        <button class="btn btn-red" onclick="showDisable2FA()">Disable 2FA</button>
        <div id="disable2fa" style="display:none;margin-top:16px">
            <div class="form-group" style="max-width:300px">
                <label for="disable_password">Enter your password to confirm</label>
                <input type="password" id="disable_password" class="form-control" required>
            </div>
            <button class="btn btn-red" onclick="disable2FA()">Confirm Disable</button>
        </div>
        {% endif %}

        <div style="margin-top:20px;padding:12px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px">
            <p style="font-size:12px;color:var(--text-muted)">
                <strong>Recovery:</strong> If you lose access to your authenticator app, remove <code>totp_secret</code> from <code>data/config.json</code> on the server and restart the app.
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Configuration -->
<div class="card">
    <div class="card-header">{{ icon('settings') }} Server Configuration</div>
    <div class="card-body">
        <form id="configForm" onsubmit="saveConfig(event)">
            <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">Thresholds</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px">
                <div class="form-group">
                    <label>Disk warning (%)</label>
                    <input type="number" class="form-control" id="cfg_disk_warning" value="{{ config.thresholds.disk_warning }}" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Disk critical (%)</label>
                    <input type="number" class="form-control" id="cfg_disk_critical" value="{{ config.thresholds.disk_critical }}" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Memory warning (%)</label>
                    <input type="number" class="form-control" id="cfg_memory_warning" value="{{ config.thresholds.memory_warning }}" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Swap warning (%)</label>
                    <input type="number" class="form-control" id="cfg_swap_warning" value="{{ config.thresholds.swap_warning }}" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>SSL warning (days)</label>
                    <input type="number" class="form-control" id="cfg_ssl_warning" value="{{ config.thresholds.ssl_warning_days }}" min="1" max="90">
                </div>
                <div class="form-group">
                    <label>SSL critical (days)</label>
                    <input type="number" class="form-control" id="cfg_ssl_critical" value="{{ config.thresholds.ssl_critical_days }}" min="1" max="30">
                </div>
            </div>

            <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">Monitor & Notifications</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px">
                <div class="form-group">
                    <label>Monitor interval (sec)</label>
                    <input type="number" class="form-control" id="cfg_monitor_interval" value="{{ config.monitor_interval }}" min="60" max="3600">
                </div>
                <div class="form-group">
                    <label>Notification cooldown (sec)</label>
                    <input type="number" class="form-control" id="cfg_notification_cooldown" value="{{ config.notification_cooldown }}" min="60" max="86400">
                </div>
            </div>

            <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">DDoS Detection</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px">
                <div class="form-group">
                    <label>Connection threshold</label>
                    <input type="number" class="form-control" id="cfg_ddos_conn" value="{{ config.ddos_detection.connection_threshold }}" min="10">
                </div>
                <div class="form-group">
                    <label>SYN threshold</label>
                    <input type="number" class="form-control" id="cfg_ddos_syn" value="{{ config.ddos_detection.syn_threshold }}" min="5">
                </div>
                <div class="form-group">
                    <label>Single IP threshold</label>
                    <input type="number" class="form-control" id="cfg_ddos_ip" value="{{ config.ddos_detection.single_ip_threshold }}" min="5">
                </div>
            </div>

            <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">Services</h4>
            <div class="form-group" style="max-width:400px">
                <label>Monitored services (comma-separated)</label>
                <input type="text" class="form-control" id="cfg_services" value="{{ config.services | join(', ') }}">
            </div>

            <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">phpMyAdmin</h4>
            <div class="form-group" style="max-width:300px">
                <label>phpMyAdmin path</label>
                <input type="text" class="form-control" id="cfg_phpmyadmin" value="{{ config.phpmyadmin_path }}">
            </div>

            <button type="submit" class="btn btn-green" style="margin-top:8px">Save Configuration</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function changePassword(e) {
    e.preventDefault();
    const data = {
        current_password: document.getElementById('current_password').value,
        new_password: document.getElementById('new_password').value,
        confirm_password: document.getElementById('confirm_password').value,
    };
    try {
        const res = await fetch('/settings/password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
        const result = await res.json();
        if (res.ok) {
            showToast(result.message, 'success');
            document.getElementById('passwordForm').reset();
        } else {
            showToast(result.message, 'error');
        }
    } catch(e) {
        showToast('Connection error', 'error');
    }
}

async function enable2FA() {
    try {
        const res = await fetch('/settings/2fa/enable', { method: 'POST' });
        const data = await res.json();
        if (res.ok) {
            document.getElementById('setup2fa').style.display = 'block';
            document.getElementById('qrCodeContainer').innerHTML = `<img src="${data.qr_code}" alt="QR Code" style="border-radius:8px">`;
            document.getElementById('totpSecret').textContent = data.secret;
        } else {
            showToast(data.message, 'error');
        }
    } catch(e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function verify2FA() {
    const code = document.getElementById('verify_code').value.trim();
    if (code.length !== 6) {
        showToast('Enter a 6-digit code', 'error');
        return;
    }
    try {
        const res = await fetch('/settings/2fa/verify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ code }),
        });
        const data = await res.json();
        if (res.ok) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message, 'error');
        }
    } catch(e) {
        showToast('Error: ' + e.message, 'error');
    }
}

function showDisable2FA() {
    document.getElementById('disable2fa').style.display = 'block';
}

async function disable2FA() {
    const password = document.getElementById('disable_password').value;
    try {
        const res = await fetch('/settings/2fa/disable', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ password }),
        });
        const data = await res.json();
        if (res.ok) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message, 'error');
        }
    } catch(e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function saveConfig(e) {
    e.preventDefault();
    const services = document.getElementById('cfg_services').value.split(',').map(s => s.trim()).filter(Boolean);
    const data = {
        thresholds: {
            disk_warning: parseInt(document.getElementById('cfg_disk_warning').value),
            disk_critical: parseInt(document.getElementById('cfg_disk_critical').value),
            memory_warning: parseInt(document.getElementById('cfg_memory_warning').value),
            swap_warning: parseInt(document.getElementById('cfg_swap_warning').value),
            ssl_warning_days: parseInt(document.getElementById('cfg_ssl_warning').value),
            ssl_critical_days: parseInt(document.getElementById('cfg_ssl_critical').value),
        },
        monitor_interval: parseInt(document.getElementById('cfg_monitor_interval').value),
        notification_cooldown: parseInt(document.getElementById('cfg_notification_cooldown').value),
        ddos_detection: {
            connection_threshold: parseInt(document.getElementById('cfg_ddos_conn').value),
            syn_threshold: parseInt(document.getElementById('cfg_ddos_syn').value),
            single_ip_threshold: parseInt(document.getElementById('cfg_ddos_ip').value),
        },
        services: services,
        phpmyadmin_path: document.getElementById('cfg_phpmyadmin').value,
    };
    try {
        const res = await fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
        const result = await res.json();
        if (res.ok) {
            showToast(result.message, 'success');
        } else {
            showToast(result.message, 'error');
        }
    } catch(e) {
        showToast('Connection error', 'error');
    }
}
</script>
{% endblock %}
