{% extends "base.html" %}
{% from "icons.html" import icon %}
{% block title %}Settings - VPS Manager{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<!-- Password Change -->
<div class="card">
    <div class="card-header">{{ icon('lock') }} Change Password</div>
    <div class="card-body">
        <form id="passwordForm" onsubmit="changePassword(event)" style="max-width:400px">
            <div class="form-group">
                <label for="current_password">Current password</label>
                <input type="password" id="current_password" class="form-control" autocomplete="current-password" required>
            </div>
            <div class="form-group">
                <label for="new_password">New password (min. 8 characters)</label>
                <input type="password" id="new_password" class="form-control" autocomplete="new-password" minlength="8" required>
            </div>
            <div class="form-group">
                <label for="confirm_password">Confirm new password</label>
                <input type="password" id="confirm_password" class="form-control" autocomplete="new-password" required>
            </div>
            <button type="submit" class="btn btn-green">Save Password</button>
        </form>
    </div>
</div>

<!-- 2FA -->
<div class="card">
    <div class="card-header">{{ icon('shield') }} Two-Factor Authentication</div>
    <div class="card-body">
        {% if not has_2fa %}
        <div class="alert alert-danger">
            <code>pyotp</code> and <code>qrcode</code> are not installed. Install them with: <code>pip install pyotp qrcode[pil]</code>
        </div>
        {% else %}
        <div id="tfaContent">
        <div style="margin-bottom:16px">
            <span class="badge {% if config.auth.totp_secret %}badge-green{% else %}badge-yellow{% endif %}" style="font-size:13px;padding:6px 12px">
                2FA is {% if config.auth.totp_secret %}enabled{% else %}disabled{% endif %}
            </span>
        </div>

        {% if not config.auth.totp_secret %}
        <button class="btn btn-green" onclick="enable2FA()">Enable 2FA</button>

        <div id="setup2fa" style="display:none;margin-top:20px">
            <p style="color:var(--text-secondary);font-size:14px;margin-bottom:12px">
                Scan the QR code with your authenticator app (Google Authenticator, Authy, etc.)
            </p>
            <div id="qrCodeContainer" style="margin-bottom:16px"></div>
            <div style="margin-bottom:16px">
                <label style="font-size:12px;color:var(--text-muted)">Manual key:</label>
                <code id="totpSecret" style="display:block;margin-top:4px;font-size:14px;word-break:break-all"></code>
            </div>
            <div class="form-group" style="max-width:200px">
                <label for="verify_code">Enter 6-digit code to verify</label>
                <input type="text" id="verify_code" class="form-control" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" placeholder="000000" required>
            </div>
            <button class="btn btn-green" onclick="verify2FA()">Verify & Enable</button>
        </div>
        {% else %}
        <button class="btn btn-red" onclick="showDisable2FA()">Disable 2FA</button>
        <div id="disable2fa" style="display:none;margin-top:16px">
            <div class="form-group" style="max-width:300px">
                <label for="disable_password">Enter your password to confirm</label>
                <input type="password" id="disable_password" class="form-control" required>
            </div>
            <button class="btn btn-red" onclick="disable2FA()">Confirm Disable</button>
        </div>
        {% endif %}

        <div style="margin-top:20px;padding:12px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px">
            <p style="font-size:12px;color:var(--text-muted)">
                <strong>Recovery:</strong> If you lose access to your authenticator app, remove <code>totp_secret</code> from <code>data/config.json</code> on the server and restart the app.
            </p>
        </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Configuration -->
<div class="card">
    <div class="card-header">{{ icon('settings') }} Server Configuration <span class="tooltip-icon" data-bs-toggle="tooltip" title="Monitoring thresholds that trigger alerts and notifications when exceeded.">?</span></div>
    <div class="card-body">
        <form id="configForm" onsubmit="saveConfig(event)">
            <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">Thresholds</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px">
                <div class="form-group">
                    <label>Disk warning (%) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Triggers a warning notification when disk usage exceeds this percentage." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_disk_warning" value="{{ config.thresholds.disk_warning }}" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Disk critical (%) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Triggers a critical alert when disk usage exceeds this. Consider freeing space immediately." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_disk_critical" value="{{ config.thresholds.disk_critical }}" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Memory warning (%) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Triggers a warning when RAM usage exceeds this percentage." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_memory_warning" value="{{ config.thresholds.memory_warning }}" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Swap warning (%) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Triggers a warning when swap usage exceeds this. High swap often means the server needs more RAM." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_swap_warning" value="{{ config.thresholds.swap_warning }}" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>SSL warning (days) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Warns when an SSL certificate has fewer than this many days until expiry." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_ssl_warning" value="{{ config.thresholds.ssl_warning_days }}" min="1" max="90">
                </div>
                <div class="form-group">
                    <label>SSL critical (days) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Critical alert when an SSL certificate has fewer than this many days left. Expired certificates cause browser warnings." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_ssl_critical" value="{{ config.thresholds.ssl_critical_days }}" min="1" max="30">
                </div>
            </div>

            <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">Monitor & Notifications</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px">
                <div class="form-group">
                    <label>Monitor interval (sec) <span class="tooltip-icon" data-bs-toggle="tooltip" title="How often the background monitor checks server health. Lower values = faster alerts but more resource usage." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_monitor_interval" value="{{ config.monitor_interval }}" min="60" max="3600">
                </div>
                <div class="form-group">
                    <label>Notification cooldown (sec) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Minimum time between repeated notifications for the same alert. Prevents notification spam." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_notification_cooldown" value="{{ config.notification_cooldown }}" min="60" max="86400">
                </div>
            </div>

            <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">Session</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px">
                <div class="form-group">
                    <label>Session lifetime (hours) <span class="tooltip-icon" data-bs-toggle="tooltip" title="How long a login session stays valid before requiring re-authentication." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_session_lifetime" value="{{ config.auth.session_lifetime_hours }}" min="1" max="720">
                </div>
            </div>

            <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">DDoS Detection</h4>
            <div class="form-group" style="margin-bottom:12px">
                <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" id="cfg_ddos_enabled" {% if config.ddos_detection.enabled %}checked{% endif %} style="accent-color:var(--green);width:16px;height:16px;cursor:pointer">
                    Enable DDoS detection <span class="tooltip-icon" data-bs-toggle="tooltip" title="When enabled, the monitor checks for unusual connection patterns and alerts you." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span>
                </label>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px">
                <div class="form-group">
                    <label>Connection threshold <span class="tooltip-icon" data-bs-toggle="tooltip" title="Maximum total network connections before a DDoS warning is triggered." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_ddos_conn" value="{{ config.ddos_detection.connection_threshold }}" min="10">
                </div>
                <div class="form-group">
                    <label>SYN threshold <span class="tooltip-icon" data-bs-toggle="tooltip" title="Maximum half-open (SYN_RECV) connections before a SYN flood warning is triggered." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_ddos_syn" value="{{ config.ddos_detection.syn_threshold }}" min="5">
                </div>
                <div class="form-group">
                    <label>Single IP threshold <span class="tooltip-icon" data-bs-toggle="tooltip" title="Maximum connections from one IP address before it is flagged as suspicious." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="number" class="form-control" id="cfg_ddos_ip" value="{{ config.ddos_detection.single_ip_threshold }}" min="5">
                </div>
            </div>

            <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">Services</h4>
            <div class="form-group" style="max-width:500px">
                <label>Monitored services (comma-separated) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Systemd services to monitor. You will be alerted if a listed service stops running." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                <div style="display:flex;gap:8px;align-items:center">
                    <input type="text" class="form-control" id="cfg_services" value="{{ config.services | join(', ') }}" style="flex:1">
                    <button type="button" class="btn" onclick="detectServices()" id="detectServicesBtn">{{ icon('refresh') }} Detect</button>
                </div>
            </div>
            <div id="detectedServices" style="display:none;margin-bottom:16px">
                <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Select services to add:</div>
                <div id="detectedServicesList" style="display:flex;flex-wrap:wrap;gap:6px"></div>
                <button type="button" class="btn btn-green btn-sm" onclick="applyDetectedServices()" style="margin-top:10px">Apply Selected</button>
            </div>

            <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">phpMyAdmin</h4>
            <div class="form-group" style="max-width:300px">
                <label>phpMyAdmin path <span class="tooltip-icon" data-bs-toggle="tooltip" title="URL path prefix for phpMyAdmin, used to generate the link on the Databases page." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                <input type="text" class="form-control" id="cfg_phpmyadmin" value="{{ config.phpmyadmin_path }}">
            </div>

            <!-- Advanced Settings -->
            <div style="margin-top:20px;margin-bottom:16px">
                <button type="button" class="btn" onclick="toggleAdvanced()" id="advancedToggleBtn" style="font-size:13px;padding:6px 14px">
                    {{ icon('settings') }} Advanced Settings <span id="advancedArrow" style="font-size:10px">&#9654;</span>
                </button>
            </div>
            <div id="advancedSettings" style="display:none;border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:20px;background:var(--bg-primary)">
                <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">File Browser</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:20px">
                    <div class="form-group">
                        <label>Default path <span class="tooltip-icon" data-bs-toggle="tooltip" title="The starting directory when opening the file browser." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                        <input type="text" class="form-control" id="cfg_fb_default_path" value="{{ config.file_browser.default_path }}">
                    </div>
                    <div class="form-group">
                        <label>Allowed paths <span class="tooltip-icon" data-bs-toggle="tooltip" title="Comma-separated list of directories the file browser is allowed to access." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                        <input type="text" class="form-control" id="cfg_fb_allowed_paths" value="{{ config.file_browser.allowed_paths | join(', ') }}">
                    </div>
                </div>

                <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">Backup</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:20px">
                    <div class="form-group">
                        <label>Log path <span class="tooltip-icon" data-bs-toggle="tooltip" title="Path to the backup log file used to display backup status." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                        <input type="text" class="form-control" id="cfg_backup_log_path" value="{{ config.backup.log_path }}">
                    </div>
                    <div class="form-group">
                        <label>Backup directory <span class="tooltip-icon" data-bs-toggle="tooltip" title="Directory where file backups are stored." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                        <input type="text" class="form-control" id="cfg_backup_dir" value="{{ config.backup.backup_dir }}">
                    </div>
                    <div class="form-group">
                        <label>DB backup directory <span class="tooltip-icon" data-bs-toggle="tooltip" title="Directory where database backups are stored." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                        <input type="text" class="form-control" id="cfg_backup_db_dir" value="{{ config.backup.db_backup_dir }}">
                    </div>
                    <div class="form-group">
                        <label>Webhook secret <span class="tooltip-icon" data-bs-toggle="tooltip" title="Shared secret for authenticating incoming backup webhook calls." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                        <input type="text" class="form-control" id="cfg_backup_webhook" value="{{ config.backup.webhook_secret }}">
                    </div>
                </div>

                <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">Nginx</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:20px">
                    <div class="form-group">
                        <label>Error log <span class="tooltip-icon" data-bs-toggle="tooltip" title="Path to the nginx error log file." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                        <input type="text" class="form-control" id="cfg_nginx_error_log" value="{{ config.nginx.error_log }}">
                    </div>
                    <div class="form-group">
                        <label>Access log <span class="tooltip-icon" data-bs-toggle="tooltip" title="Path to the nginx access log file." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                        <input type="text" class="form-control" id="cfg_nginx_access_log" value="{{ config.nginx.access_log }}">
                    </div>
                    <div class="form-group">
                        <label>Sites enabled <span class="tooltip-icon" data-bs-toggle="tooltip" title="Path to the nginx sites-enabled directory." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                        <input type="text" class="form-control" id="cfg_nginx_sites_enabled" value="{{ config.nginx.sites_enabled }}">
                    </div>
                </div>

                <h4 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary)">Push Notifications</h4>
                <div class="form-group" style="max-width:400px">
                    <label>VAPID mailto <span class="tooltip-icon" data-bs-toggle="tooltip" title="Contact email for VAPID push notification identification (must start with mailto:)." style="font-size:11px;width:14px;height:14px;line-height:14px">?</span></label>
                    <input type="text" class="form-control" id="cfg_vapid_mailto" value="{{ config.vapid_mailto }}">
                </div>
            </div>

            <button type="submit" class="btn btn-green" style="margin-top:8px">Save Configuration</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function changePassword(e) {
    e.preventDefault();
    const data = {
        current_password: document.getElementById('current_password').value,
        new_password: document.getElementById('new_password').value,
        confirm_password: document.getElementById('confirm_password').value,
    };
    try {
        const res = await fetch('/settings/password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify(data),
        });
        const result = await res.json();
        if (res.ok) {
            showToast(result.message, 'success');
            document.getElementById('passwordForm').reset();
        } else {
            showToast(result.message, 'error');
        }
    } catch(e) {
        showToast('Connection error', 'error');
    }
}

async function enable2FA() {
    try {
        const res = await fetch('/settings/2fa/enable', { method: 'POST', headers: {'X-CSRFToken': csrfToken} });
        const data = await res.json();
        if (res.ok) {
            document.getElementById('setup2fa').style.display = 'block';
            document.getElementById('qrCodeContainer').innerHTML = `<img src="${data.qr_code}" alt="QR Code" style="border-radius:8px">`;
            document.getElementById('totpSecret').textContent = data.secret;
        } else {
            showToast(data.message, 'error');
        }
    } catch(e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function verify2FA() {
    const code = document.getElementById('verify_code').value.trim();
    if (code.length !== 6) {
        showToast('Enter a 6-digit code', 'error');
        return;
    }
    try {
        const res = await fetch('/settings/2fa/verify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({ code }),
        });
        const data = await res.json();
        if (res.ok) {
            showToast(data.message, 'success');
            // Update UI in-place: show enabled state
            var tfaContent = document.getElementById('tfaContent');
            if (tfaContent) {
                tfaContent.innerHTML = '<div style="margin-bottom:16px"><span class="badge badge-green" style="font-size:13px;padding:6px 12px">2FA is enabled</span></div>'
                    + '<button class="btn btn-red" onclick="showDisable2FA()">Disable 2FA</button>'
                    + '<div id="disable2fa" style="display:none;margin-top:16px"><div class="form-group" style="max-width:300px"><label for="disable_password">Enter your password to confirm</label><input type="password" id="disable_password" class="form-control" required></div><button class="btn btn-red" onclick="disable2FA()">Confirm Disable</button></div>'
                    + '<div style="margin-top:20px;padding:12px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px"><p style="font-size:12px;color:var(--text-muted)"><strong>Recovery:</strong> If you lose access to your authenticator app, remove <code>totp_secret</code> from <code>data/config.json</code> on the server and restart the app.</p></div>';
            }
        } else {
            showToast(data.message, 'error');
        }
    } catch(e) {
        showToast('Error: ' + e.message, 'error');
    }
}

function showDisable2FA() {
    document.getElementById('disable2fa').style.display = 'block';
}

async function disable2FA() {
    const password = document.getElementById('disable_password').value;
    try {
        const res = await fetch('/settings/2fa/disable', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({ password }),
        });
        const data = await res.json();
        if (res.ok) {
            showToast(data.message, 'success');
            // Update UI in-place: show disabled state
            var tfaContent = document.getElementById('tfaContent');
            if (tfaContent) {
                tfaContent.innerHTML = '<div style="margin-bottom:16px"><span class="badge badge-yellow" style="font-size:13px;padding:6px 12px">2FA is disabled</span></div>'
                    + '<button class="btn btn-green" onclick="enable2FA()">Enable 2FA</button>'
                    + '<div id="setup2fa" style="display:none;margin-top:20px"><p style="color:var(--text-secondary);font-size:14px;margin-bottom:12px">Scan the QR code with your authenticator app (Google Authenticator, Authy, etc.)</p><div id="qrCodeContainer" style="margin-bottom:16px"></div><div style="margin-bottom:16px"><label style="font-size:12px;color:var(--text-muted)">Manual key:</label><code id="totpSecret" style="display:block;margin-top:4px;font-size:14px;word-break:break-all"></code></div><div class="form-group" style="max-width:200px"><label for="verify_code">Enter 6-digit code to verify</label><input type="text" id="verify_code" class="form-control" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" placeholder="000000" required></div><button class="btn btn-green" onclick="verify2FA()">Verify &amp; Enable</button></div>'
                    + '<div style="margin-top:20px;padding:12px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px"><p style="font-size:12px;color:var(--text-muted)"><strong>Recovery:</strong> If you lose access to your authenticator app, remove <code>totp_secret</code> from <code>data/config.json</code> on the server and restart the app.</p></div>';
            }
        } else {
            showToast(data.message, 'error');
        }
    } catch(e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function detectServices() {
    const btn = document.getElementById('detectServicesBtn');
    btn.disabled = true;
    try {
        const res = await fetch('/api/services/detect');
        const services = await res.json();
        if (!services.length) {
            showToast('No services detected', 'error');
            btn.disabled = false;
            return;
        }

        const current = document.getElementById('cfg_services').value.split(',').map(s => s.trim()).filter(Boolean);
        const container = document.getElementById('detectedServicesList');
        container.innerHTML = '';

        services.forEach(svc => {
            const isExisting = current.includes(svc);
            const badge = document.createElement('label');
            badge.style.cssText = 'display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer;border:1px solid var(--border);background:var(--bg-tertiary);transition:all 0.15s';
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = svc;
            cb.checked = true;
            cb.style.cssText = 'accent-color:var(--green);cursor:pointer';
            if (isExisting) {
                badge.style.opacity = '0.5';
                badge.title = 'Already monitored';
            }
            badge.appendChild(cb);
            badge.appendChild(document.createTextNode(svc));
            container.appendChild(badge);
        });

        document.getElementById('detectedServices').style.display = 'block';
    } catch (e) {
        showToast('Connection error', 'error');
    }
    btn.disabled = false;
}

function applyDetectedServices() {
    const current = document.getElementById('cfg_services').value.split(',').map(s => s.trim()).filter(Boolean);
    const checkboxes = document.querySelectorAll('#detectedServicesList input[type="checkbox"]:checked');
    const newServices = new Set(current);
    checkboxes.forEach(cb => newServices.add(cb.value));
    document.getElementById('cfg_services').value = Array.from(newServices).join(', ');
    document.getElementById('detectedServices').style.display = 'none';
    showToast(`${newServices.size} services configured`, 'success');
}

function toggleAdvanced() {
    const el = document.getElementById('advancedSettings');
    const arrow = document.getElementById('advancedArrow');
    if (el.style.display === 'none') {
        el.style.display = 'block';
        arrow.innerHTML = '&#9660;';
    } else {
        el.style.display = 'none';
        arrow.innerHTML = '&#9654;';
    }
}

async function saveConfig(e) {
    e.preventDefault();
    const services = document.getElementById('cfg_services').value.split(',').map(s => s.trim()).filter(Boolean);
    const allowedPaths = document.getElementById('cfg_fb_allowed_paths').value.split(',').map(s => s.trim()).filter(Boolean);
    const data = {
        thresholds: {
            disk_warning: parseInt(document.getElementById('cfg_disk_warning').value),
            disk_critical: parseInt(document.getElementById('cfg_disk_critical').value),
            memory_warning: parseInt(document.getElementById('cfg_memory_warning').value),
            swap_warning: parseInt(document.getElementById('cfg_swap_warning').value),
            ssl_warning_days: parseInt(document.getElementById('cfg_ssl_warning').value),
            ssl_critical_days: parseInt(document.getElementById('cfg_ssl_critical').value),
        },
        monitor_interval: parseInt(document.getElementById('cfg_monitor_interval').value),
        notification_cooldown: parseInt(document.getElementById('cfg_notification_cooldown').value),
        auth: {
            session_lifetime_hours: parseInt(document.getElementById('cfg_session_lifetime').value),
        },
        ddos_detection: {
            enabled: document.getElementById('cfg_ddos_enabled').checked,
            connection_threshold: parseInt(document.getElementById('cfg_ddos_conn').value),
            syn_threshold: parseInt(document.getElementById('cfg_ddos_syn').value),
            single_ip_threshold: parseInt(document.getElementById('cfg_ddos_ip').value),
        },
        services: services,
        phpmyadmin_path: document.getElementById('cfg_phpmyadmin').value,
        file_browser: {
            default_path: document.getElementById('cfg_fb_default_path').value,
            allowed_paths: allowedPaths,
        },
        backup: {
            log_path: document.getElementById('cfg_backup_log_path').value,
            backup_dir: document.getElementById('cfg_backup_dir').value,
            db_backup_dir: document.getElementById('cfg_backup_db_dir').value,
            webhook_secret: document.getElementById('cfg_backup_webhook').value,
        },
        nginx: {
            error_log: document.getElementById('cfg_nginx_error_log').value,
            access_log: document.getElementById('cfg_nginx_access_log').value,
            sites_enabled: document.getElementById('cfg_nginx_sites_enabled').value,
        },
        vapid_mailto: document.getElementById('cfg_vapid_mailto').value,
    };
    try {
        const res = await fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify(data),
        });
        const result = await res.json();
        if (res.ok) {
            showToast(result.message, 'success');
        } else {
            showToast(result.message, 'error');
        }
    } catch(e) {
        showToast('Connection error', 'error');
    }
}
</script>
{% endblock %}
