{% extends "base.html" %}

{% block title %}Notifications - VPS Manager{% endblock %}
{% block page_title %}Notifications{% endblock %}

{% block content %}
<div class="stats-grid" style="grid-template-columns: 1fr;">

    <!-- Push Permission -->
    <div class="card">
        <div class="card-header">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            Push Notifications
        </div>
        <div class="card-body">
            <div id="push-status" style="margin-bottom:16px;">
                <p id="push-status-text" style="color:var(--text-secondary);font-size:14px;">Checking notification support...</p>
            </div>

            <div id="push-unsupported" style="display:none;">
                <div class="alert alert-danger">Push notifications are not supported in this browser. Use Chrome, Edge, or Firefox for push support.</div>
            </div>

            <div id="push-controls" style="display:none;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <button class="btn btn-green" id="btnEnable" onclick="enablePush()">Enable Notifications</button>
                    <button class="btn btn-red" id="btnDisable" onclick="disablePush()" style="display:none;">Disable Notifications</button>
                    <button class="btn" id="btnTest" onclick="sendTest()" style="display:none;">Send Test</button>
                </div>
                <p id="push-permission-hint" style="color:var(--text-muted);font-size:12px;display:none;">
                    If the permission prompt doesn't appear, check your browser's notification settings for this site.
                </p>
            </div>
        </div>
    </div>

    <!-- Categories (this device) -->
    <div class="card" id="categories-card" style="display:none;">
        <div class="card-header">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
            Notification Categories
        </div>
        <div class="card-body">
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Choose which alerts you want to receive on <strong>this device</strong>.</p>

            <div class="notif-categories">
                <div class="notif-category">
                    <div class="notif-category-info">
                        <div class="notif-category-title">Critical Errors</div>
                        <div class="notif-category-desc">Site down, services down, PM2 offline, disk >95%, SSL expired</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pref-critical" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="notif-category">
                    <div class="notif-category-info">
                        <div class="notif-category-title">Warnings</div>
                        <div class="notif-category-desc">Disk >80%, RAM >85%, swap >50%, high load, SSL &lt;14 days</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pref-warnings" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="notif-category">
                    <div class="notif-category-info">
                        <div class="notif-category-title">System Updates</div>
                        <div class="notif-category-desc">Available package updates</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pref-updates">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="notif-category">
                    <div class="notif-category-info">
                        <div class="notif-category-title">Security</div>
                        <div class="notif-category-desc">Fail2ban bans, suspicious SSH activity</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pref-security" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="notif-category">
                    <div class="notif-category-info">
                        <div class="notif-category-title">DDoS Detection</div>
                        <div class="notif-category-desc">High connection counts, SYN floods, single IP spikes</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pref-ddos" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="notif-category">
                    <div class="notif-category-info">
                        <div class="notif-category-title">Backup</div>
                        <div class="notif-category-desc">Backup failures, no successful backup in 48 hours</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pref-backup" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="notif-category">
                    <div class="notif-category-info">
                        <div class="notif-category-title">App Updates</div>
                        <div class="notif-category-desc">New VPS Manager release available on GitHub</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pref-app_update" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <button class="btn btn-green" onclick="savePreferences()" style="margin-top:16px;">Save Preferences</button>
        </div>
    </div>

    <!-- All Active Subscriptions -->
    <div class="card">
        <div class="card-header">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 3h-8l-2 4h12z"/></svg>
            Active Subscriptions
        </div>
        <div class="card-body">
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Manage all registered notification endpoints. You can edit labels and preferences for any device, including ones you can't access directly.</p>
            <div id="subs-list">
                <p style="color:var(--text-muted);font-size:13px;">Loading subscriptions...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal for editing subscription preferences -->
<div id="sub-prefs-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="margin:0;font-size:16px;" id="modal-title">Edit Preferences</h3>
            <button onclick="closeSubModal()" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:20px;">&times;</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let swRegistration = null;
    let currentSubscription = null;

    function detectLabel() {
        const ua = navigator.userAgent;
        const isPWA = window.matchMedia('(display-mode: standalone)').matches
                    || window.navigator.standalone === true;
        let browser = 'Browser';
        if (ua.includes('Firefox')) browser = 'Firefox';
        else if (ua.includes('Edg/')) browser = 'Edge';
        else if (ua.includes('Chrome')) browser = 'Chrome';
        else if (ua.includes('Safari')) browser = 'Safari';
        const mode = isPWA ? 'PWA' : 'Browser';
        return browser + ' ' + mode;
    }

    async function init() {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            document.getElementById('push-unsupported').style.display = 'block';
            document.getElementById('push-status-text').textContent = 'Push notifications not supported.';
            return;
        }

        document.getElementById('push-controls').style.display = 'block';

        try {
            swRegistration = await navigator.serviceWorker.ready;
            currentSubscription = await swRegistration.pushManager.getSubscription();
            updateUI();
        } catch (e) {
            document.getElementById('push-status-text').textContent = 'Error initializing: ' + e.message;
        }

        loadAllSubscriptions();
    }

    function updateUI() {
        const statusText = document.getElementById('push-status-text');
        const btnEnable = document.getElementById('btnEnable');
        const btnDisable = document.getElementById('btnDisable');
        const btnTest = document.getElementById('btnTest');
        const categoriesCard = document.getElementById('categories-card');
        const hint = document.getElementById('push-permission-hint');

        if (currentSubscription) {
            statusText.innerHTML = '<span style="color:var(--green);">&#10003;</span> Push notifications are <strong>enabled</strong> (' + detectLabel() + ').';
            btnEnable.style.display = 'none';
            btnDisable.style.display = '';
            btnTest.style.display = '';
            categoriesCard.style.display = '';
            hint.style.display = 'none';
            loadPreferences();
        } else {
            statusText.textContent = 'Push notifications are disabled.';
            btnEnable.style.display = '';
            btnDisable.style.display = 'none';
            btnTest.style.display = 'none';
            categoriesCard.style.display = 'none';

            if (Notification.permission === 'denied') {
                statusText.textContent = 'Notifications are blocked by the browser. Please allow notifications in site settings.';
                btnEnable.style.display = 'none';
                hint.style.display = 'block';
            }
        }
    }

    async function enablePush() {
        try {
            const res = await fetch('/api/push/vapid-key');
            const data = await res.json();
            const vapidKey = urlBase64ToUint8Array(data.public_key);

            const subscription = await swRegistration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: vapidKey,
            });

            const subData = subscription.toJSON();
            subData.label = detectLabel();

            const subRes = await fetch('/api/push/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(subData),
            });

            if (subRes.ok) {
                currentSubscription = subscription;
                updateUI();
                loadAllSubscriptions();
                showToast('Push notifications enabled', 'success');
            } else {
                showToast('Failed to register subscription', 'error');
            }
        } catch (e) {
            if (e.name === 'NotAllowedError') {
                document.getElementById('push-permission-hint').style.display = 'block';
            }
            showToast('Could not enable notifications: ' + e.message, 'error');
        }
    }

    async function disablePush() {
        try {
            if (currentSubscription) {
                await fetch('/api/push/unsubscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ endpoint: currentSubscription.endpoint }),
                });
                await currentSubscription.unsubscribe();
            }
            currentSubscription = null;
            updateUI();
            loadAllSubscriptions();
            showToast('Push notifications disabled', 'success');
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function sendTest() {
        try {
            const res = await fetch('/api/push/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ endpoint: currentSubscription.endpoint }),
            });
            if (res.ok) {
                showToast('Test notification sent', 'success');
            } else {
                showToast('Failed to send test', 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function loadPreferences() {
        try {
            const res = await fetch('/api/push/preferences?' + new URLSearchParams({
                endpoint: currentSubscription.endpoint,
            }));
            if (res.ok) {
                const prefs = await res.json();
                document.getElementById('pref-critical').checked = prefs.critical !== false;
                document.getElementById('pref-warnings').checked = prefs.warnings !== false;
                document.getElementById('pref-updates').checked = prefs.updates === true;
                document.getElementById('pref-security').checked = prefs.security !== false;
                document.getElementById('pref-ddos').checked = prefs.ddos !== false;
                document.getElementById('pref-backup').checked = prefs.backup !== false;
                document.getElementById('pref-app_update').checked = prefs.app_update !== false;
            }
        } catch (e) {
            // Use defaults
        }
    }

    async function savePreferences() {
        const prefs = {
            endpoint: currentSubscription.endpoint,
            critical: document.getElementById('pref-critical').checked,
            warnings: document.getElementById('pref-warnings').checked,
            updates: document.getElementById('pref-updates').checked,
            security: document.getElementById('pref-security').checked,
            ddos: document.getElementById('pref-ddos').checked,
            backup: document.getElementById('pref-backup').checked,
            app_update: document.getElementById('pref-app_update').checked,
        };

        try {
            const res = await fetch('/api/push/preferences', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(prefs),
            });
            if (res.ok) {
                showToast('Preferences saved', 'success');
                loadAllSubscriptions();
            } else {
                showToast('Failed to save preferences', 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    // ---- All Subscriptions Management ----

    let allSubscriptions = [];

    async function loadAllSubscriptions() {
        try {
            const res = await fetch('/api/push/subscriptions');
            if (!res.ok) return;
            allSubscriptions = await res.json();
            renderSubscriptions();
        } catch (e) {
            document.getElementById('subs-list').innerHTML = '<p style="color:var(--red);font-size:13px;">Failed to load subscriptions.</p>';
        }
    }

    function renderSubscriptions() {
        const container = document.getElementById('subs-list');
        if (!allSubscriptions.length) {
            container.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">No active subscriptions.</p>';
            return;
        }

        const currentEp = currentSubscription ? currentSubscription.endpoint : null;
        let html = '';
        allSubscriptions.forEach((sub, idx) => {
            const isCurrent = sub.endpoint === currentEp;
            const label = sub.label || sub.provider || 'Unknown';
            const prefs = sub.preferences || {};
            const enabledPrefs = Object.entries(prefs).filter(([k, v]) => v).map(([k]) => {
                const names = {critical:'Critical',warnings:'Warnings',updates:'Updates',security:'Security',ddos:'DDoS',backup:'Backup',app_update:'App Updates'};
                return names[k] || k;
            });
            const created = sub.created ? new Date(sub.created).toLocaleDateString('nl-NL', {day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '';

            html += '<div style="border:1px solid var(--border-color);border-radius:8px;padding:14px;margin-bottom:10px;' + (isCurrent ? 'border-color:var(--green);' : '') + '">';
            html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">';
            html += '<div style="flex:1;min-width:200px;">';
            html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">';
            html += '<strong style="font-size:14px;">' + escapeHtml(label) + '</strong>';
            if (isCurrent) html += '<span style="font-size:11px;background:var(--green);color:#000;padding:1px 8px;border-radius:10px;">This device</span>';
            html += '</div>';
            html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;">' + sub.provider + ' &middot; ' + escapeHtml(sub.endpoint_short) + (created ? ' &middot; ' + created : '') + '</div>';
            html += '<div style="font-size:12px;color:var(--text-secondary);">' + (enabledPrefs.length ? enabledPrefs.join(', ') : '<span style="color:var(--text-muted);">No categories enabled</span>') + '</div>';
            html += '</div>';
            html += '<div style="display:flex;gap:6px;align-items:center;">';
            html += '<button class="btn" style="font-size:12px;padding:4px 12px;" onclick="editSubPrefs(' + idx + ')">Edit</button>';
            html += '<button class="btn btn-red" style="font-size:12px;padding:4px 12px;" onclick="deleteSub(' + idx + ')">Delete</button>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
        });
        container.innerHTML = html;
    }

    function escapeHtml(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }

    function editSubPrefs(idx) {
        const sub = allSubscriptions[idx];
        if (!sub) return;
        const prefs = sub.preferences || {};
        const label = sub.label || '';
        const cats = [
            {key:'critical',name:'Critical Errors'},
            {key:'warnings',name:'Warnings'},
            {key:'updates',name:'System Updates'},
            {key:'security',name:'Security'},
            {key:'ddos',name:'DDoS Detection'},
            {key:'backup',name:'Backup'},
            {key:'app_update',name:'App Updates'},
        ];

        let html = '<div style="margin-bottom:14px;">';
        html += '<label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:4px;">Label</label>';
        html += '<input type="text" id="modal-label" value="' + escapeHtml(label) + '" maxlength="50" style="width:100%;background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary);padding:8px 12px;border-radius:6px;font-size:14px;">';
        html += '</div>';
        html += '<div style="margin-bottom:14px;">';
        html += '<label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:8px;">Categories</label>';
        cats.forEach(c => {
            const checked = prefs[c.key] !== false && (c.key !== 'updates' || prefs[c.key] === true);
            html += '<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;">';
            html += '<span style="font-size:13px;">' + c.name + '</span>';
            html += '<label class="toggle-switch"><input type="checkbox" id="modal-pref-' + c.key + '"' + (checked ? ' checked' : '') + '><span class="toggle-slider"></span></label>';
            html += '</div>';
        });
        html += '</div>';
        html += '<div style="display:flex;gap:8px;">';
        html += '<button class="btn btn-green" onclick="saveSubPrefs(' + idx + ')">Save</button>';
        html += '<button class="btn" onclick="closeSubModal()">Cancel</button>';
        html += '</div>';

        document.getElementById('modal-title').textContent = 'Edit: ' + (label || sub.provider);
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('sub-prefs-modal').style.display = 'flex';
        document.getElementById('sub-prefs-modal').dataset.endpoint = sub.endpoint;
    }

    function closeSubModal() {
        document.getElementById('sub-prefs-modal').style.display = 'none';
    }

    async function saveSubPrefs(idx) {
        const sub = allSubscriptions[idx];
        if (!sub) return;
        const endpoint = sub.endpoint;
        const newLabel = document.getElementById('modal-label').value.trim();
        const cats = ['critical','warnings','updates','security','ddos','backup','app_update'];
        const prefs = { endpoint };
        cats.forEach(c => { prefs[c] = document.getElementById('modal-pref-' + c).checked; });

        try {
            // Save label
            if (newLabel !== (sub.label || '')) {
                await fetch('/api/push/subscriptions/label', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ endpoint, label: newLabel }),
                });
            }
            // Save preferences
            const res = await fetch('/api/push/subscriptions/preferences', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(prefs),
            });
            if (res.ok) {
                showToast('Subscription updated', 'success');
                closeSubModal();
                loadAllSubscriptions();
                // Reload current device prefs if editing our own
                if (currentSubscription && endpoint === currentSubscription.endpoint) {
                    loadPreferences();
                }
            } else {
                showToast('Failed to save', 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function deleteSub(idx) {
        const sub = allSubscriptions[idx];
        if (!sub) return;
        const label = sub.label || sub.provider;
        if (!confirm('Delete subscription "' + label + '"? This device will no longer receive push notifications.')) return;

        try {
            const res = await fetch('/api/push/subscriptions/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ endpoint: sub.endpoint }),
            });
            if (res.ok) {
                // If deleting current device subscription, also unsubscribe locally
                if (currentSubscription && sub.endpoint === currentSubscription.endpoint) {
                    try { await currentSubscription.unsubscribe(); } catch(e) {}
                    currentSubscription = null;
                    updateUI();
                }
                showToast('Subscription deleted', 'success');
                loadAllSubscriptions();
            } else {
                showToast('Failed to delete', 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    // Convert VAPID key from base64 to Uint8Array
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    init();
</script>
{% endblock %}
