{% extends "base.html" %}
{% from "icons.html" import icon %}
{% block title %}Dashboard - VPS Manager{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}

{% block content %}
{% if data %}
    {% if alerts %}
    <div class="alerts-card card" style="margin-bottom:24px" id="alertsCard">
        <div class="card-header">
            {{ icon('activity') }} Alerts
            <span class="badge badge-{% if alerts|selectattr('severity','equalto','error')|list %}red{% elif alerts|selectattr('severity','equalto','warning')|list %}yellow{% else %}green{% endif %}" style="margin-left:auto" id="alertsBadge">{{ alerts|length }}</span>
        </div>
        <div class="card-body" style="padding:0" id="alertsList">
            {% for alert in alerts %}
            <div class="alert-item alert-{{ alert.severity }}" data-alert-id="{{ loop.index0 }}" data-alert-key="{{ alert.key }}">
                {% if alert.link %}
                <a href="{{ alert.link }}" class="alert-link">
                {% endif %}
                <span class="alert-icon">
                    {% if alert.severity == 'error' %}
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    {% elif alert.severity == 'warning' %}
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    {% else %}
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    {% endif %}
                </span>
                <span class="alert-message">{{ alert.message }}</span>
                {% if alert.link %}
                </a>
                {% endif %}
                <button class="alert-dismiss" onclick="dismissAlert(this)" title="Dismiss">&times;</button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="stats-grid">
        <div class="stat-card" style="border-top-color:var(--accent)">
            <div class="label">Hostname</div>
            <div class="value" style="font-size:18px">{{ data.hostname }}</div>
            <div class="sub">{{ data.os }}</div>
        </div>
        <div class="stat-card" style="border-top-color:var(--green)">
            <div class="label">Uptime</div>
            <div class="value" style="font-size:18px">{{ data.uptime }}</div>
            <div class="sub">{{ data.cpu_model }} ({{ data.cpu_cores }} cores)</div>
        </div>
        <div class="stat-card" style="border-top-color:var(--purple)">
            <div class="label">Load Average</div>
            <div class="value" style="font-size:18px">{{ data.load }}</div>
            <div class="sub">1 / 5 / 15 min</div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="label">Memory</div>
            <div class="value">{{ data.mem_pct }}%</div>
            <div class="sub">{{ data.mem_used_gb }}G / {{ data.mem_total_gb }}G (free: {{ data.mem_avail_gb }}G)</div>
            <div class="progress-wrap">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill {% if data.mem_pct > 80 %}red{% elif data.mem_pct > 60 %}yellow{% else %}green{% endif %}" style="width:{{ data.mem_pct }}%"></div>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="label">Disk /</div>
            <div class="value">{{ data.disk_pct }}%</div>
            <div class="sub">{{ data.disk_used }} / {{ data.disk_size }} (free: {{ data.disk_avail }})</div>
            <div class="progress-wrap">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill {% if data.disk_pct > 80 %}red{% elif data.disk_pct > 60 %}yellow{% else %}green{% endif %}" style="width:{{ data.disk_pct }}%"></div>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="label">Swap</div>
            <div class="value">{{ data.swap_pct }}%</div>
            <div class="sub">{{ data.swap }}</div>
            <div class="progress-wrap">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill {% if data.swap_pct > 80 %}red{% elif data.swap_pct > 50 %}yellow{% else %}green{% endif %}" style="width:{{ data.swap_pct }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-title">CPU Load (1 min avg)</div>
            <div class="chart-value" id="chartCpuValue">--</div>
            <div class="chart-wrap">
                <canvas id="chartCpu"></canvas>
                <div class="chart-empty" id="chartCpuEmpty">Collecting data...</div>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-title">Memory Usage</div>
            <div class="chart-value" id="chartMemValue">--</div>
            <div class="chart-wrap">
                <canvas id="chartMem"></canvas>
                <div class="chart-empty" id="chartMemEmpty">Collecting data...</div>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-title">Disk Usage</div>
            <div class="chart-value" id="chartDiskValue">--</div>
            <div class="chart-wrap">
                <canvas id="chartDisk"></canvas>
                <div class="chart-empty" id="chartDiskEmpty">Collecting data...</div>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-title">Network I/O</div>
            <div class="chart-value" id="chartNetValue">--</div>
            <div class="chart-wrap">
                <canvas id="chartNet"></canvas>
                <div class="chart-empty" id="chartNetEmpty">Collecting data...</div>
            </div>
        </div>
    </div>

    <div class="quick-status">
        <div class="quick-item">
            {% set active_count = services|selectattr('status', 'equalto', 'active')|list|length %}
            <div class="qi-value" style="color:{% if active_count == services|length %}var(--green){% else %}var(--yellow){% endif %}">{{ active_count }}/{{ services|length }}</div>
            <div class="qi-label">Services active</div>
        </div>
        <div class="quick-item">
            {% set online_count = pm2|selectattr('status', 'equalto', 'online')|list|length %}
            <div class="qi-value" style="color:{% if online_count == pm2|length %}var(--green){% else %}var(--yellow){% endif %}">{{ online_count }}/{{ pm2|length }}</div>
            <div class="qi-label">PM2 online</div>
        </div>
        <div class="quick-item">
            {% if ssl %}
                {% set min_days = ssl|map(attribute='days_left')|min %}
                <div class="qi-value" style="color:{% if min_days > 30 %}var(--green){% elif min_days > 7 %}var(--yellow){% else %}var(--red){% endif %}">{{ min_days }}d</div>
                <div class="qi-label">SSL minimum</div>
            {% else %}
                <div class="qi-value" style="color:var(--text-muted)">?</div>
                <div class="qi-label">SSL status</div>
            {% endif %}
        </div>
    </div>

    <div class="grid-2col">
        <a href="{{ url_for('services') }}" class="card card-link">
            <div class="card-header">{{ icon('activity') }} Services</div>
            <div class="card-body">
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Service</th><th>Status</th></tr></thead>
                        <tbody>
                            {% for svc in services %}
                            <tr>
                                <td>{{ svc.name }}</td>
                                <td>
                                    {% if svc.status == 'active' %}
                                        <span class="badge badge-green"><span class="badge-dot green"></span>active</span>
                                    {% else %}
                                        <span class="badge badge-red"><span class="badge-dot red"></span>{{ svc.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </a>
        <a href="{{ url_for('pm2') }}" class="card card-link">
            <div class="card-header">{{ icon('settings') }} PM2 Processes</div>
            <div class="card-body">
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Process</th><th>Status</th><th>Memory</th></tr></thead>
                        <tbody>
                            {% for p in pm2 %}
                            <tr>
                                <td>{{ p.name }}</td>
                                <td>
                                    {% if p.status == 'online' %}
                                        <span class="badge badge-green"><span class="badge-dot green"></span>online</span>
                                    {% elif p.status == 'stopped' %}
                                        <span class="badge badge-yellow"><span class="badge-dot yellow"></span>stopped</span>
                                    {% else %}
                                        <span class="badge badge-red"><span class="badge-dot red"></span>{{ p.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ p.memory }} MB</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </a>
    </div>

    <div style="margin-top:32px;text-align:right">
        <button class="btn btn-red" onclick="showConfirm('Server Reboot', 'Are you sure you want to reboot the VPS? All services will be temporarily unavailable.', doReboot)">{{ icon('refresh') }} Server Reboot</button>
    </div>
{% else %}
    <div class="empty-state"><p>Unable to retrieve server data.</p></div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
async function doReboot() { await apiCall('/reboot', 'POST'); }

// --- Charts ---
const chartInstances = {};
const chartColors = {
    cpu: { border: '#58a6ff', bg: [0.3, 0.0] },
    mem: { border: '#3fb950', bg: [0.3, 0.0] },
    disk: { border: '#bc8cff', bg: [0.3, 0.0] },
    netRx: { border: '#39d2c0' },
    netTx: { border: '#d29922' },
};

function makeGradient(ctx, canvas, r, g, b, stops) {
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.parentElement.clientHeight);
    gradient.addColorStop(0, `rgba(${r},${g},${b},${stops[0]})`);
    gradient.addColorStop(1, `rgba(${r},${g},${b},${stops[1]})`);
    return gradient;
}

function baseChartOpts(yLabel, yMax) {
    return {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { intersect: false, mode: 'index' },
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: '#21262d',
                borderColor: '#30363d',
                borderWidth: 1,
                titleColor: '#e6edf3',
                bodyColor: '#b1bac4',
                padding: 10,
                titleFont: { size: 12 },
                bodyFont: { size: 12 },
            },
        },
        scales: {
            x: {
                type: 'time',
                time: { unit: 'hour', displayFormats: { hour: 'HH:mm' }, tooltipFormat: 'HH:mm' },
                grid: { color: 'rgba(48,54,61,0.5)', drawBorder: false },
                ticks: { color: '#8b949e', font: { size: 11 }, maxTicksLimit: 8 },
            },
            y: {
                min: 0,
                max: yMax || undefined,
                grid: { color: 'rgba(48,54,61,0.5)', drawBorder: false },
                ticks: { color: '#8b949e', font: { size: 11 } },
                title: { display: !!yLabel, text: yLabel || '', color: '#8b949e', font: { size: 11 } },
            },
        },
        elements: {
            line: { tension: 0.4, borderWidth: 2 },
            point: { radius: 0, hoverRadius: 4 },
        },
    };
}

function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B/s';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB/s';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB/s';
}

function initCharts() {
    // CPU
    const cpuCanvas = document.getElementById('chartCpu');
    const cpuCtx = cpuCanvas.getContext('2d');
    chartInstances.cpu = new Chart(cpuCtx, {
        type: 'line',
        data: { datasets: [{ fill: true, backgroundColor: makeGradient(cpuCtx, cpuCanvas, 88, 166, 255, [0.3, 0.0]), borderColor: chartColors.cpu.border, data: [] }] },
        options: baseChartOpts('Load'),
    });

    // Memory
    const memCanvas = document.getElementById('chartMem');
    const memCtx = memCanvas.getContext('2d');
    chartInstances.mem = new Chart(memCtx, {
        type: 'line',
        data: { datasets: [{ fill: true, backgroundColor: makeGradient(memCtx, memCanvas, 63, 185, 80, [0.3, 0.0]), borderColor: chartColors.mem.border, data: [] }] },
        options: baseChartOpts('%', 100),
    });

    // Disk
    const diskCanvas = document.getElementById('chartDisk');
    const diskCtx = diskCanvas.getContext('2d');
    chartInstances.disk = new Chart(diskCtx, {
        type: 'line',
        data: { datasets: [{ fill: true, backgroundColor: makeGradient(diskCtx, diskCanvas, 188, 140, 255, [0.3, 0.0]), borderColor: chartColors.disk.border, data: [] }] },
        options: baseChartOpts('%', 100),
    });

    // Network (two lines)
    const netCanvas = document.getElementById('chartNet');
    const netCtx = netCanvas.getContext('2d');
    const netOpts = baseChartOpts('');
    netOpts.plugins.legend = { display: true, labels: { color: '#8b949e', boxWidth: 12, font: { size: 11 } } };
    netOpts.scales.y.ticks.callback = function(val) { return formatBytes(val); };
    netOpts.plugins.tooltip.callbacks = { label: function(ctx) { return ctx.dataset.label + ': ' + formatBytes(ctx.parsed.y); } };
    chartInstances.net = new Chart(netCtx, {
        type: 'line',
        data: {
            datasets: [
                { label: 'RX', fill: false, borderColor: chartColors.netRx.border, data: [] },
                { label: 'TX', fill: false, borderColor: chartColors.netTx.border, data: [] },
            ],
        },
        options: netOpts,
    });
}

function updateCharts(metrics) {
    if (!metrics || !metrics.length) return;

    // Hide empty states
    ['Cpu', 'Mem', 'Disk', 'Net'].forEach(n => {
        const el = document.getElementById('chart' + n + 'Empty');
        if (el) el.style.display = 'none';
    });

    const last = metrics[metrics.length - 1];

    // Update current values
    document.getElementById('chartCpuValue').textContent = last.cpu.toFixed(2);
    document.getElementById('chartMemValue').textContent = last.mem.toFixed(1) + '%';
    document.getElementById('chartDiskValue').textContent = last.disk + '%';
    document.getElementById('chartNetValue').textContent = formatBytes(last.net_rx) + ' / ' + formatBytes(last.net_tx);

    // Map to chart data
    const cpuData = metrics.map(m => ({ x: m.ts * 1000, y: m.cpu }));
    const memData = metrics.map(m => ({ x: m.ts * 1000, y: m.mem }));
    const diskData = metrics.map(m => ({ x: m.ts * 1000, y: m.disk }));
    const rxData = metrics.map(m => ({ x: m.ts * 1000, y: m.net_rx }));
    const txData = metrics.map(m => ({ x: m.ts * 1000, y: m.net_tx }));

    chartInstances.cpu.data.datasets[0].data = cpuData;
    chartInstances.mem.data.datasets[0].data = memData;
    chartInstances.disk.data.datasets[0].data = diskData;
    chartInstances.net.data.datasets[0].data = rxData;
    chartInstances.net.data.datasets[1].data = txData;

    chartInstances.cpu.update('none');
    chartInstances.mem.update('none');
    chartInstances.disk.update('none');
    chartInstances.net.update('none');
}

async function fetchMetrics() {
    try {
        const res = await fetch('/api/metrics');
        if (res.ok) {
            const data = await res.json();
            updateCharts(data);
        }
    } catch (e) {}
}

// Init charts and start polling
if (typeof Chart !== 'undefined') {
    initCharts();
    fetchMetrics();
    setInterval(fetchMetrics, 60000);
}

// Alert dismiss logic
function getDismissedAlerts() {
    try {
        return JSON.parse(sessionStorage.getItem('dismissedAlerts') || '[]');
    } catch { return []; }
}

function dismissAlert(btn) {
    const item = btn.closest('.alert-item');
    const key = item.dataset.alertKey;
    // Save to sessionStorage
    const dismissed = getDismissedAlerts();
    if (!dismissed.includes(key)) dismissed.push(key);
    sessionStorage.setItem('dismissedAlerts', JSON.stringify(dismissed));
    // Animate out
    item.style.transition = 'opacity 0.2s, max-height 0.3s';
    item.style.opacity = '0';
    item.style.maxHeight = item.offsetHeight + 'px';
    setTimeout(() => {
        item.style.maxHeight = '0';
        item.style.padding = '0 16px';
        item.style.borderBottom = 'none';
    }, 150);
    setTimeout(() => {
        item.remove();
        updateAlertsBadge();
    }, 400);
}

function updateAlertsBadge() {
    const remaining = document.querySelectorAll('#alertsList .alert-item');
    const badge = document.getElementById('alertsBadge');
    const card = document.getElementById('alertsCard');
    if (remaining.length === 0) {
        card.style.display = 'none';
    } else {
        badge.textContent = remaining.length;
    }
}

// Hide previously dismissed alerts on load
(function() {
    const dismissed = getDismissedAlerts();
    if (!dismissed.length) return;
    document.querySelectorAll('#alertsList .alert-item').forEach(item => {
        if (dismissed.includes(item.dataset.alertKey)) {
            item.remove();
        }
    });
    updateAlertsBadge();
})();
</script>
{% endblock %}
