{% extends "base.html" %}
{% from "icons.html" import icon %}
{% block title %}Firewall - VPS Manager{% endblock %}
{% block page_title %}Firewall & Security{% endblock %}

{% block content %}
<div class="grid-2col">
    <div class="card">
        <div class="card-header">
            {{ icon('shield') }} UFW Firewall Rules
            <span class="tooltip-icon" data-bs-toggle="tooltip" title="UFW (Uncomplicated Firewall) controls which network connections are allowed or blocked on the server.">?</span>
        </div>
        <div class="card-body">
            {% if data.ufw %}
                <pre>{{ data.ufw }}</pre>
            {% else %}
                <div class="empty-state">Unable to retrieve UFW status</div>
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            {{ icon('ban') }} Fail2ban SSHD Status
            <span class="tooltip-icon" data-bs-toggle="tooltip" title="Fail2ban monitors log files and blocks IPs that show suspicious behavior such as repeated failed login attempts.">?</span>
        </div>
        <div class="card-body">
            {% if data.fail2ban %}
                <pre>{{ data.fail2ban }}</pre>
            {% else %}
                <div class="empty-state">Unable to retrieve fail2ban status</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Fail2ban Config & Jails -->
<div class="grid-2col" style="margin-top:16px">
    <div class="card">
        <div class="card-header">
            {{ icon('settings') }} Fail2ban Configuration
            <span class="tooltip-icon" data-bs-toggle="tooltip" title="These settings control how fail2ban detects and blocks malicious IPs. Ban time is how long an IP stays blocked, find time is the detection window, and max retry is how many attempts are allowed.">?</span>
        </div>
        <div class="card-body">
            {% if data.f2b_config %}
            <div class="table-wrap">
                <table>
                    <tbody>
                        <tr>
                            <td><strong>Ban Time</strong></td>
                            <td>
                                {{ data.f2b_config.bantime or '?' }}
                                {% if data.f2b_config.permanent_bans %}
                                    <span class="badge badge-red" style="margin-left:8px">Permanent</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Find Time</strong></td>
                            <td>{{ data.f2b_config.findtime or '?' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Max Retry</strong></td>
                            <td>{{ data.f2b_config.maxretry or '?' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="empty-state">Unable to retrieve fail2ban config</div>
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            {{ icon('list') }} Active Jails
            <span class="tooltip-icon" data-bs-toggle="tooltip" title="A jail is a set of rules that monitors a specific service log file. Each jail can independently ban IPs that violate its rules.">?</span>
        </div>
        <div class="card-body">
            {% if data.jails %}
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Jail</th><th>Status</th><th>Banned</th><th>Total</th></tr></thead>
                    <tbody>
                        {% for jail in data.jails %}
                        <tr>
                            <td><strong>{{ jail.name }}</strong></td>
                            <td>
                                {% if jail.status == 'active' %}
                                    <span class="badge badge-green"><span class="badge-dot green"></span>active</span>
                                {% else %}
                                    <span class="badge badge-red">{{ jail.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if jail.banned > 0 %}
                                    <span class="badge badge-yellow">{{ jail.banned }}</span>
                                {% else %}
                                    <span style="color:var(--text-muted)">0</span>
                                {% endif %}
                            </td>
                            <td style="color:var(--text-muted)">{{ jail.total_banned }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="empty-state">No jails found</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- DDoS Detection -->
<div class="card" style="margin-top:16px">
    <div class="card-header">
        {{ icon('activity') }} DDoS Detection
        <span class="tooltip-icon" data-bs-toggle="tooltip" title="Real-time connection monitoring. High connection counts from a single IP or many SYN_RECV connections can indicate a DDoS attack.">?</span>
    </div>
    <div class="card-body">
        {% if data.ddos %}
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px">
            <div class="stat-card" style="border:none;padding:12px;background:var(--bg-tertiary);border-radius:8px">
                <div class="label">Established</div>
                <div class="value" style="font-size:24px;color:{% if data.ddos.total_connections > data.ddos.conn_threshold %}var(--red){% elif data.ddos.total_connections > data.ddos.conn_threshold * 0.7 %}var(--yellow){% else %}var(--green){% endif %}">{{ data.ddos.total_connections }}</div>
                <div class="sub">threshold: {{ data.ddos.conn_threshold }}</div>
            </div>
            <div class="stat-card" style="border:none;padding:12px;background:var(--bg-tertiary);border-radius:8px">
                <div class="label">SYN_RECV</div>
                <div class="value" style="font-size:24px;color:{% if data.ddos.syn_recv > data.ddos.syn_threshold %}var(--red){% elif data.ddos.syn_recv > data.ddos.syn_threshold * 0.5 %}var(--yellow){% else %}var(--green){% endif %}">{{ data.ddos.syn_recv }}</div>
                <div class="sub">threshold: {{ data.ddos.syn_threshold }}</div>
            </div>
            <div class="stat-card" style="border:none;padding:12px;background:var(--bg-tertiary);border-radius:8px">
                <div class="label">Top IP</div>
                {% if data.ddos.top_ips %}
                <div class="value" style="font-size:16px;color:{% if data.ddos.top_ips[0].count > data.ddos.ip_threshold %}var(--red){% else %}var(--text){% endif %}">{{ data.ddos.top_ips[0].count }}x</div>
                <div class="sub">{{ data.ddos.top_ips[0].ip }}</div>
                {% else %}
                <div class="value" style="font-size:24px;color:var(--green)">0</div>
                <div class="sub">no connections</div>
                {% endif %}
            </div>
        </div>
        {% if data.ddos.top_ips|length > 1 %}
        <div class="table-wrap">
            <table>
                <thead><tr><th>IP Address</th><th>Connections</th></tr></thead>
                <tbody>
                    {% for entry in data.ddos.top_ips %}
                    <tr>
                        <td><code>{{ entry.ip }}</code></td>
                        <td>
                            {% if entry.count > data.ddos.ip_threshold %}
                                <span class="badge badge-red">{{ entry.count }}</span>
                            {% else %}
                                {{ entry.count }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        {% else %}
            <div class="empty-state">DDoS detection disabled</div>
        {% endif %}
    </div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
    <div class="card">
        <div class="card-header">
            {{ icon('ban') }} Banned IPs (all jails)
            <span class="tooltip-icon" data-bs-toggle="tooltip" title="Currently blocked IPs. Bans expire after the configured ban time unless permanent bans are enabled.">?</span>
        </div>
        <div class="card-body">
            {% if data.banned %}
                {% if data.banned in ['[{}]', '[]'] %}
                    <span class="badge badge-green">No banned IPs</span>
                {% else %}
                    <pre style="color:var(--red)">{{ data.banned }}</pre>
                {% endif %}
            {% else %}
                <div class="empty-state">No data</div>
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-header">{{ icon('users') }} Active SSH sessions</div>
        <div class="card-body">
            {% if data.sessions %}
                <pre>{{ data.sessions }}</pre>
            {% else %}
                <span style="color:var(--text-muted)">No active sessions</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="card" style="margin-top:16px">
    <div class="card-header">{{ icon('clipboard') }} Recent SSH login attempts</div>
    <div class="card-body">
        {% if data.auth_log %}
            <pre>{{ data.auth_log }}</pre>
        {% else %}
            <div class="empty-state">Unable to read auth.log</div>
        {% endif %}
    </div>
</div>

<!-- Ban IP -->
<div class="card" style="margin-top:16px">
    <div class="card-header">
        {{ icon('ban') }} Ban IP Address
        <span class="tooltip-icon" data-bs-toggle="tooltip" title="Permanently ban an IP address via fail2ban and add a UFW deny rule. The IP will be blocked immediately.">?</span>
    </div>
    <div class="card-body">
        <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
            <div class="form-group" style="flex:1;min-width:200px;margin-bottom:0">
                <label style="font-size:12px;color:var(--text-muted);margin-bottom:4px;display:block">IP Address</label>
                <input type="text" id="banIpInput" class="form-control" placeholder="e.g. 1.2.3.4">
            </div>
            <div class="form-group" style="min-width:150px;margin-bottom:0">
                <label style="font-size:12px;color:var(--text-muted);margin-bottom:4px;display:block">Jail</label>
                <select id="banJailSelect" class="form-control">
                    {% if data.jails %}
                        {% for jail in data.jails %}
                        <option value="{{ jail.name }}" {% if jail.name == 'sshd' %}selected{% endif %}>{{ jail.name }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="sshd">sshd</option>
                    {% endif %}
                </select>
            </div>
            <button class="btn btn-red" onclick="banIp()" id="banBtn">{{ icon('ban') }} Ban</button>
        </div>
    </div>
</div>

<!-- Currently Banned IPs (structured) -->
<div class="card" style="margin-top:16px">
    <div class="card-header">
        {{ icon('shield') }} Currently Banned IPs
        <button class="btn btn-sm" onclick="loadBannedIps()" style="margin-left:auto">{{ icon('refresh') }} Refresh</button>
    </div>
    <div class="card-body">
        <div id="bannedIpsContainer">
            <div class="empty-state">Loading...</div>
        </div>
    </div>
</div>

<!-- Whitelist Management -->
<div class="card" style="margin-top:16px">
    <div class="card-header">
        {{ icon('list') }} Fail2ban Whitelist (ignoreip)
        <span class="tooltip-icon" data-bs-toggle="tooltip" title="IPs in this whitelist will never be banned by fail2ban. Always keep 127.0.0.1 and your own IP here to avoid locking yourself out.">?</span>
    </div>
    <div class="card-body">
        <div id="whitelistContainer">
            <div class="empty-state">Loading...</div>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-end;margin-top:16px;flex-wrap:wrap">
            <div class="form-group" style="flex:1;min-width:200px;margin-bottom:0">
                <label style="font-size:12px;color:var(--text-muted);margin-bottom:4px;display:block">Add IP / CIDR</label>
                <input type="text" id="whitelistInput" class="form-control" placeholder="e.g. 192.168.1.0/24">
            </div>
            <button class="btn" onclick="addWhitelistIp()">+ Add</button>
            <button class="btn btn-green" onclick="saveWhitelist()" id="saveWhitelistBtn">{{ icon('save') }} Save</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let whitelistIps = [];

    // --- Ban IP ---
    async function banIp() {
        const ip = document.getElementById('banIpInput').value.trim();
        const jail = document.getElementById('banJailSelect').value;
        if (!ip) { showToast('Enter an IP address', 'error'); return; }
        if (!/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/.test(ip)) {
            showToast('Invalid IPv4 address', 'error'); return;
        }
        showConfirm('Ban IP', `Permanently ban ${ip} in jail "${jail}" and add a UFW deny rule?`, async function() {
            const btn = document.getElementById('banBtn');
            btn.disabled = true;
            try {
                const res = await fetch('/firewall/ban', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify({ip, jail}),
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(data.message, 'success');
                    document.getElementById('banIpInput').value = '';
                    loadBannedIps();
                } else {
                    showToast(data.message || 'Ban failed', 'error');
                }
            } catch (e) {
                showToast('Connection error', 'error');
            }
            btn.disabled = false;
        });
    }

    // --- Banned IPs ---
    function formatDuration(seconds) {
        if (seconds === 'permanent' || seconds < 0) return '<span class="badge badge-red">permanent</span>';
        if (seconds <= 0) return '<span style="color:var(--text-muted)">expiring...</span>';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        if (h > 0) return `${h}h ${m}m`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
    }

    function formatBanDuration(seconds) {
        if (seconds === 'permanent' || seconds < 0) return 'permanent';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        if (h > 0) return `${h}h ${m}m`;
        return `${m}m`;
    }

    let bannedIpsInterval = null;

    async function loadBannedIps() {
        const container = document.getElementById('bannedIpsContainer');
        try {
            const res = await fetch('/firewall/banned-ips');
            const jails = await res.json();

            let totalBanned = 0;
            jails.forEach(j => totalBanned += j.ips.length);

            if (totalBanned === 0) {
                container.innerHTML = '<span class="badge badge-green">No banned IPs</span>';
                if (bannedIpsInterval) { clearInterval(bannedIpsInterval); bannedIpsInterval = null; }
                return;
            }

            let html = '<div class="table-wrap"><table><thead><tr><th>IP Address</th><th>Jail</th><th>Banned at</th><th>Duration</th><th>Remaining</th><th style="width:80px">Action</th></tr></thead><tbody>';
            jails.forEach(j => {
                j.ips.forEach(entry => {
                    const ip = typeof entry === 'string' ? entry : entry.ip;
                    const bannedAt = entry.banned_at || '-';
                    const duration = entry.duration != null ? formatBanDuration(entry.duration) : '-';
                    const remaining = entry.remaining != null ? formatDuration(entry.remaining) : '-';
                    const bancount = entry.bancount || 1;
                    const countBadge = bancount > 1 ? ` <span class="badge badge-red" title="Banned ${bancount} times" style="font-size:10px">${bancount}x</span>` : '';
                    html += `<tr>
                        <td><code>${escHtml(ip)}</code>${countBadge}</td>
                        <td><span class="badge badge-yellow">${escHtml(j.jail)}</span></td>
                        <td style="font-size:12px;color:var(--text-muted)">${escHtml(bannedAt)}</td>
                        <td style="font-size:12px">${duration}</td>
                        <td>${remaining}</td>
                        <td><button class="btn btn-sm btn-green" onclick="unbanIp('${escHtml(ip)}', '${escHtml(j.jail)}')">Unban</button></td>
                    </tr>`;
                });
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;

            // Auto-refresh every 30s while bans are active
            if (!bannedIpsInterval) {
                bannedIpsInterval = setInterval(loadBannedIps, 30000);
            }
        } catch (e) {
            container.innerHTML = '<div class="empty-state">Failed to load banned IPs</div>';
        }
    }

    async function unbanIp(ip, jail) {
        showConfirm('Unban IP', `Unban ${ip} from jail "${jail}"?`, async function() {
            try {
                const res = await fetch('/firewall/unban', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify({ip, jail}),
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(data.message, 'success');
                    loadBannedIps();
                } else {
                    showToast(data.message || 'Unban failed', 'error');
                }
            } catch (e) {
                showToast('Connection error', 'error');
            }
        });
    }

    // --- Whitelist ---
    async function loadWhitelist() {
        const container = document.getElementById('whitelistContainer');
        try {
            const res = await fetch('/firewall/whitelist');
            const data = await res.json();
            whitelistIps = data.ips || [];
            renderWhitelist();
        } catch (e) {
            container.innerHTML = '<div class="empty-state">Failed to load whitelist</div>';
        }
    }

    function renderWhitelist() {
        const container = document.getElementById('whitelistContainer');
        if (whitelistIps.length === 0) {
            container.innerHTML = '<span style="color:var(--text-muted)">No whitelisted IPs</span>';
            return;
        }
        let html = '<div class="table-wrap"><table><thead><tr><th>IP / CIDR</th><th style="width:80px">Action</th></tr></thead><tbody>';
        whitelistIps.forEach((ip, idx) => {
            html += `<tr>
                <td><code>${escHtml(ip)}</code></td>
                <td><button class="btn btn-sm btn-red" onclick="removeWhitelistIp(${idx})">{{ icon('trash') }} Del</button></td>
            </tr>`;
        });
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function addWhitelistIp() {
        const input = document.getElementById('whitelistInput');
        const val = input.value.trim();
        if (!val) { showToast('Enter an IP or CIDR', 'error'); return; }
        // Basic validation: IPv4 or CIDR or ::1
        if (val !== '::1' && !/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)(\/\d{1,2})?$/.test(val)) {
            showToast('Invalid IP or CIDR notation', 'error'); return;
        }
        if (whitelistIps.includes(val)) {
            showToast('IP already in whitelist', 'error'); return;
        }
        whitelistIps.push(val);
        input.value = '';
        renderWhitelist();
    }

    function removeWhitelistIp(idx) {
        whitelistIps.splice(idx, 1);
        renderWhitelist();
    }

    async function saveWhitelist() {
        const btn = document.getElementById('saveWhitelistBtn');
        btn.disabled = true;
        try {
            const res = await fetch('/firewall/whitelist', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                body: JSON.stringify({ips: whitelistIps}),
            });
            const data = await res.json();
            if (res.ok) {
                showToast(data.message, 'success');
            } else {
                showToast(data.message || 'Save failed', 'error');
            }
        } catch (e) {
            showToast('Connection error', 'error');
        }
        btn.disabled = false;
    }

    function escHtml(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadBannedIps();
        loadWhitelist();
    });
</script>
{% endblock %}
