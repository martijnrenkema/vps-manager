{% extends "base.html" %}
{% from "icons.html" import icon %}
{% block title %}Firewall - VPS Manager{% endblock %}
{% block page_title %}Firewall & Security{% endblock %}

{% block content %}
<div class="grid-2col">
    <div class="card">
        <div class="card-header">
            {{ icon('shield') }} UFW Firewall Rules
            <span class="tooltip-icon" data-bs-toggle="tooltip" title="UFW (Uncomplicated Firewall) controls which network connections are allowed or blocked on the server.">?</span>
        </div>
        <div class="card-body">
            {% if data.ufw %}
                <pre>{{ data.ufw }}</pre>
            {% else %}
                <div class="empty-state">Unable to retrieve UFW status</div>
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            {{ icon('ban') }} Fail2ban SSHD Status
            <span class="tooltip-icon" data-bs-toggle="tooltip" title="Fail2ban monitors log files and blocks IPs that show suspicious behavior such as repeated failed login attempts.">?</span>
        </div>
        <div class="card-body">
            {% if data.fail2ban %}
                <pre>{{ data.fail2ban }}</pre>
            {% else %}
                <div class="empty-state">Unable to retrieve fail2ban status</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Fail2ban Config & Jails -->
<div class="grid-2col" style="margin-top:16px">
    <div class="card">
        <div class="card-header">
            {{ icon('settings') }} Fail2ban Configuration
            <span class="tooltip-icon" data-bs-toggle="tooltip" title="These settings control how fail2ban detects and blocks malicious IPs. Ban time is how long an IP stays blocked, find time is the detection window, and max retry is how many attempts are allowed.">?</span>
        </div>
        <div class="card-body">
            {% if data.f2b_config %}
            <div class="table-wrap">
                <table>
                    <tbody>
                        <tr>
                            <td><strong>Ban Time</strong></td>
                            <td>
                                {{ data.f2b_config.bantime or '?' }}
                                {% if data.f2b_config.permanent_bans %}
                                    <span class="badge badge-red" style="margin-left:8px">Permanent</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Find Time</strong></td>
                            <td>{{ data.f2b_config.findtime or '?' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Max Retry</strong></td>
                            <td>{{ data.f2b_config.maxretry or '?' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="empty-state">Unable to retrieve fail2ban config</div>
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            {{ icon('list') }} Active Jails
            <span class="tooltip-icon" data-bs-toggle="tooltip" title="A jail is a set of rules that monitors a specific service log file. Each jail can independently ban IPs that violate its rules.">?</span>
        </div>
        <div class="card-body">
            {% if data.jails %}
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Jail</th><th>Status</th><th>Banned</th><th>Total</th></tr></thead>
                    <tbody>
                        {% for jail in data.jails %}
                        <tr>
                            <td><strong>{{ jail.name }}</strong></td>
                            <td>
                                {% if jail.status == 'active' %}
                                    <span class="badge badge-green"><span class="badge-dot green"></span>active</span>
                                {% else %}
                                    <span class="badge badge-red">{{ jail.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if jail.banned > 0 %}
                                    <span class="badge badge-yellow">{{ jail.banned }}</span>
                                {% else %}
                                    <span style="color:var(--text-muted)">0</span>
                                {% endif %}
                            </td>
                            <td style="color:var(--text-muted)">{{ jail.total_banned }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="empty-state">No jails found</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- DDoS Detection -->
<div class="card" style="margin-top:16px">
    <div class="card-header">
        {{ icon('activity') }} DDoS Detection
        <span class="tooltip-icon" data-bs-toggle="tooltip" title="Real-time connection monitoring. High connection counts from a single IP or many SYN_RECV connections can indicate a DDoS attack.">?</span>
    </div>
    <div class="card-body">
        {% if data.ddos %}
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px">
            <div class="stat-card" style="border:none;padding:12px;background:var(--bg-tertiary);border-radius:8px">
                <div class="label">Established</div>
                <div class="value" style="font-size:24px;color:{% if data.ddos.total_connections > data.ddos.conn_threshold %}var(--red){% elif data.ddos.total_connections > data.ddos.conn_threshold * 0.7 %}var(--yellow){% else %}var(--green){% endif %}">{{ data.ddos.total_connections }}</div>
                <div class="sub">threshold: {{ data.ddos.conn_threshold }}</div>
            </div>
            <div class="stat-card" style="border:none;padding:12px;background:var(--bg-tertiary);border-radius:8px">
                <div class="label">SYN_RECV</div>
                <div class="value" style="font-size:24px;color:{% if data.ddos.syn_recv > data.ddos.syn_threshold %}var(--red){% elif data.ddos.syn_recv > data.ddos.syn_threshold * 0.5 %}var(--yellow){% else %}var(--green){% endif %}">{{ data.ddos.syn_recv }}</div>
                <div class="sub">threshold: {{ data.ddos.syn_threshold }}</div>
            </div>
            <div class="stat-card" style="border:none;padding:12px;background:var(--bg-tertiary);border-radius:8px">
                <div class="label">Top IP</div>
                {% if data.ddos.top_ips %}
                <div class="value" style="font-size:16px;color:{% if data.ddos.top_ips[0].count > data.ddos.ip_threshold %}var(--red){% else %}var(--text){% endif %}">{{ data.ddos.top_ips[0].count }}x</div>
                <div class="sub">{{ data.ddos.top_ips[0].ip }}</div>
                {% else %}
                <div class="value" style="font-size:24px;color:var(--green)">0</div>
                <div class="sub">no connections</div>
                {% endif %}
            </div>
        </div>
        {% if data.ddos.top_ips|length > 1 %}
        <div class="table-wrap">
            <table>
                <thead><tr><th>IP Address</th><th>Connections</th></tr></thead>
                <tbody>
                    {% for entry in data.ddos.top_ips %}
                    <tr>
                        <td><code>{{ entry.ip }}</code></td>
                        <td>
                            {% if entry.count > data.ddos.ip_threshold %}
                                <span class="badge badge-red">{{ entry.count }}</span>
                            {% else %}
                                {{ entry.count }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        {% else %}
            <div class="empty-state">DDoS detection disabled</div>
        {% endif %}
    </div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
    <div class="card">
        <div class="card-header">
            {{ icon('ban') }} Banned IPs (all jails)
            <span class="tooltip-icon" data-bs-toggle="tooltip" title="Currently blocked IPs. Bans expire after the configured ban time unless permanent bans are enabled.">?</span>
        </div>
        <div class="card-body">
            {% if data.banned %}
                {% if data.banned in ['[{}]', '[]'] %}
                    <span class="badge badge-green">No banned IPs</span>
                {% else %}
                    <pre style="color:var(--red)">{{ data.banned }}</pre>
                {% endif %}
            {% else %}
                <div class="empty-state">No data</div>
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-header">{{ icon('users') }} Active SSH sessions</div>
        <div class="card-body">
            {% if data.sessions %}
                <pre>{{ data.sessions }}</pre>
            {% else %}
                <span style="color:var(--text-muted)">No active sessions</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="card" style="margin-top:16px">
    <div class="card-header">{{ icon('clipboard') }} Recent SSH login attempts</div>
    <div class="card-body">
        {% if data.auth_log %}
            <pre>{{ data.auth_log }}</pre>
        {% else %}
            <div class="empty-state">Unable to read auth.log</div>
        {% endif %}
    </div>
</div>
{% endblock %}
