{% extends "base.html" %}
{% from "icons.html" import icon %}
{% block title %}Files - VPS Manager{% endblock %}
{% block page_title %}Files{% endblock %}

{% block content %}
<div class="file-browser">
    <!-- Toolbar -->
    <div class="file-toolbar">
        <div class="breadcrumb" id="breadcrumb"></div>
        <div class="btn-group">
            <button class="btn btn-green" onclick="showMkdirDialog()">{{ icon('folder-plus') }} New folder</button>
            <button class="btn btn-green" onclick="document.getElementById('uploadInput').click()">{{ icon('upload') }} Upload</button>
            <form id="uploadForm" style="display:none">
                <input type="file" id="uploadInput" multiple onchange="uploadFiles(this.files)">
            </form>
        </div>
    </div>

    <!-- File table -->
    <div class="card">
        <div class="card-body" style="padding:0">
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th style="width:40px"></th>
                            <th>Name</th>
                            <th style="width:100px">Size</th>
                            <th style="width:160px">Modified</th>
                            <th style="width:100px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="fileList">
                        <tr><td colspan="5" class="empty-state">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Mkdir dialog -->
<div class="confirm-overlay" id="mkdirOverlay">
    <div class="confirm-box">
        <h3>New folder</h3>
        <div class="form-group" style="text-align:left;margin:16px 0">
            <label>Folder name</label>
            <input type="text" class="form-control" id="mkdirName" placeholder="name" onkeydown="if(event.key==='Enter')doMkdir()">
        </div>
        <div class="btn-group" style="justify-content:center">
            <button class="btn" onclick="closeMkdir()">Cancel</button>
            <button class="btn btn-green" onclick="doMkdir()">Create</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPath = '/var/www';

function loadDir(path) {
    currentPath = path;
    fetch(`/files/list?path=${encodeURIComponent(path)}`)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                showToast(data.error, 'error');
                return;
            }
            currentPath = data.path;
            renderBreadcrumb(data.path);
            renderFiles(data);
        })
        .catch(() => showToast('Unable to load directory', 'error'));
}

function renderBreadcrumb(path) {
    const bc = document.getElementById('breadcrumb');
    bc.innerHTML = '';
    const root = document.createElement('span');
    root.className = 'bc-item';
    root.textContent = '/';
    root.onclick = () => loadDir('/');
    bc.appendChild(root);

    const parts = path.split('/').filter(Boolean);
    let built = '';
    for (const part of parts) {
        built += '/' + part;
        const sep = document.createElement('span');
        sep.className = 'bc-sep';
        sep.textContent = '/';
        bc.appendChild(sep);
        const item = document.createElement('span');
        item.className = 'bc-item';
        item.textContent = part;
        const p = built;
        item.onclick = () => loadDir(p);
        bc.appendChild(item);
    }
}

function renderFiles(data) {
    const tbody = document.getElementById('fileList');
    tbody.innerHTML = '';

    const dirIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--yellow)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>';
    const fileIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>';

    // Parent directory link
    if (data.parent !== null) {
        const tr = document.createElement('tr');
        tr.className = 'file-row';
        tr.ondblclick = () => loadDir(data.parent);
        tr.innerHTML = `<td class="file-icon">${dirIcon}</td><td></td><td>-</td><td>-</td><td></td>`;
        const link = document.createElement('a');
        link.href = '#';
        link.className = 'file-link';
        link.textContent = '..';
        link.onclick = (e) => { e.preventDefault(); loadDir(data.parent); };
        tr.children[1].appendChild(link);
        tbody.appendChild(tr);
    }

    if (data.items.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="5" class="empty-state">Folder is empty</td>';
        tbody.appendChild(tr);
        return;
    }

    for (const item of data.items) {
        const fullPath = data.path + (data.path.endsWith('/') ? '' : '/') + item.name;
        const tr = document.createElement('tr');
        tr.className = 'file-row';

        // Icon cell
        const iconTd = document.createElement('td');
        iconTd.className = 'file-icon';
        iconTd.innerHTML = item.type === 'dir' ? dirIcon : fileIcon;

        // Name cell
        const nameTd = document.createElement('td');
        if (item.type === 'dir') {
            const link = document.createElement('a');
            link.href = '#';
            link.className = 'file-link';
            link.textContent = item.name;
            link.onclick = (e) => { e.preventDefault(); loadDir(fullPath); };
            nameTd.appendChild(link);
            tr.ondblclick = () => loadDir(fullPath);
        } else {
            const span = document.createElement('span');
            span.className = 'file-name';
            span.textContent = item.name;
            nameTd.appendChild(span);
        }

        // Size & modified cells
        const sizeTd = document.createElement('td');
        sizeTd.textContent = item.size;
        const modTd = document.createElement('td');
        modTd.textContent = item.modified;

        // Actions cell
        const actTd = document.createElement('td');
        actTd.className = 'file-actions';
        if (item.type === 'file') {
            const dl = document.createElement('a');
            dl.href = '/files/download?path=' + encodeURIComponent(fullPath);
            dl.className = 'btn btn-sm';
            dl.title = 'Download';
            dl.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
            actTd.appendChild(dl);
            actTd.appendChild(document.createTextNode(' '));
        }
        const del = document.createElement('button');
        del.className = 'btn btn-sm btn-red';
        del.title = 'Delete';
        del.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
        del.onclick = () => deleteItem(fullPath, item.type);
        actTd.appendChild(del);

        tr.appendChild(iconTd);
        tr.appendChild(nameTd);
        tr.appendChild(sizeTd);
        tr.appendChild(modTd);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
    }
}

function escHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

function deleteItem(path, type) {
    const label = type === 'dir' ? 'folder' : 'file';
    const name = path.split('/').pop();
    showConfirm('Delete', `Are you sure you want to delete ${label} "${name}"?`, async () => {
        try {
            const res = await fetch('/files/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                body: JSON.stringify({path})
            });
            const data = await res.json();
            if (res.ok) {
                showToast(data.message, 'success');
                loadDir(currentPath);
            } else {
                showToast(data.message || 'Error', 'error');
            }
        } catch (e) {
            showToast('Connection error', 'error');
        }
    });
}

function showMkdirDialog() {
    document.getElementById('mkdirName').value = '';
    document.getElementById('mkdirOverlay').classList.add('active');
    setTimeout(() => document.getElementById('mkdirName').focus(), 100);
}

function closeMkdir() {
    document.getElementById('mkdirOverlay').classList.remove('active');
}

async function doMkdir() {
    const name = document.getElementById('mkdirName').value.trim();
    if (!name) return;
    closeMkdir();
    try {
        const res = await fetch('/files/mkdir', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({path: currentPath, name})
        });
        const data = await res.json();
        if (res.ok) {
            showToast(data.message, 'success');
            loadDir(currentPath);
        } else {
            showToast(data.message || 'Fout', 'error');
        }
    } catch (e) {
        showToast('Connection error', 'error');
    }
}

async function uploadFiles(files) {
    if (!files.length) return;
    for (const file of files) {
        const form = new FormData();
        form.append('path', currentPath);
        form.append('file', file);
        try {
            const res = await fetch('/files/upload', {method: 'POST', headers: {'X-CSRFToken': csrfToken}, body: form});
            const data = await res.json();
            if (res.ok) {
                showToast(data.message, 'success');
            } else {
                showToast(data.message || 'Upload failed', 'error');
            }
        } catch (e) {
            showToast(`Upload failed: ${file.name}`, 'error');
        }
    }
    document.getElementById('uploadInput').value = '';
    loadDir(currentPath);
}

// Close mkdir overlay on backdrop click / escape
document.getElementById('mkdirOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeMkdir();
});
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeMkdir();
});

// Initial load
loadDir(currentPath);
</script>
{% endblock %}
