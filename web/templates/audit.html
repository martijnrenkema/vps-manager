{% extends "base.html" %}
{% from "icons.html" import icon %}
{% block title %}Audit Log - VPS Manager{% endblock %}
{% block page_title %}Audit Log{% endblock %}

{% block content %}
<div class="file-toolbar" style="margin-bottom:16px">
    <div class="btn-group" style="flex-wrap:wrap;gap:6px">
        <button class="btn btn-sm filter-btn active" data-filter="" onclick="filterAction(this, '')">All</button>
        <button class="btn btn-sm filter-btn" data-filter="login" onclick="filterAction(this, 'login')">Login</button>
        <button class="btn btn-sm filter-btn" data-filter="logout" onclick="filterAction(this, 'logout')">Logout</button>
        <button class="btn btn-sm filter-btn" data-filter="config_update" onclick="filterAction(this, 'config_update')">Config</button>
        <button class="btn btn-sm filter-btn" data-filter="service_restart" onclick="filterAction(this, 'service_restart')">Services</button>
        <button class="btn btn-sm filter-btn" data-filter="firewall_ban" onclick="filterAction(this, 'firewall_ban')">Firewall</button>
        <button class="btn btn-sm filter-btn" data-filter="file_" onclick="filterAction(this, 'file_')">Files</button>
        <button class="btn btn-sm filter-btn" data-filter="cronjob_" onclick="filterAction(this, 'cronjob_')">Cronjobs</button>
        <button class="btn btn-sm filter-btn" data-filter="nginx_" onclick="filterAction(this, 'nginx_')">Nginx</button>
    </div>
    <div class="btn-group">
        <input type="text" class="form-control" id="auditSearch" placeholder="Search..." style="width:200px;padding:4px 10px;font-size:12px" oninput="renderAuditLog()">
        <button class="btn btn-sm btn-red" onclick="clearAuditLog()">{{ icon('trash') }} Clear</button>
    </div>
</div>

<div class="card">
    <div class="card-body" style="padding:0">
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th style="width:160px">Timestamp</th>
                        <th style="width:80px">User</th>
                        <th style="width:120px">IP</th>
                        <th style="width:160px">Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="auditTableBody">
                    <tr><td colspan="5" class="empty-state">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div style="display:flex;justify-content:center;gap:8px;margin-top:16px" id="auditPagination"></div>
{% endblock %}

{% block scripts %}
<script>
let auditData = [];
let currentFilter = '';
let currentPage = 1;
const perPage = 50;

const actionColors = {
    'login': 'var(--green)',
    'login_failed': 'var(--red)',
    'logout': 'var(--text-muted)',
    'config_update': 'var(--accent)',
    'password_change': 'var(--yellow)',
    '2fa_enable': 'var(--green)',
    '2fa_disable': 'var(--red)',
    'server_reboot': 'var(--red)',
    'service_restart': 'var(--yellow)',
    'service_stop': 'var(--red)',
    'service_start': 'var(--green)',
    'firewall_ban': 'var(--red)',
    'firewall_unban': 'var(--green)',
    'firewall_whitelist': 'var(--accent)',
    'file_upload': 'var(--accent)',
    'file_delete': 'var(--red)',
    'file_save': 'var(--green)',
    'file_mkdir': 'var(--accent)',
    'file_chown': 'var(--yellow)',
    'file_chmod': 'var(--yellow)',
    'cronjob_add': 'var(--green)',
    'cronjob_edit': 'var(--yellow)',
    'cronjob_delete': 'var(--red)',
    'nginx_config_save': 'var(--accent)',
    'nginx_config_enable': 'var(--green)',
    'nginx_config_disable': 'var(--red)',
    'audit_clear': 'var(--text-muted)',
};

async function loadAuditLog() {
    try {
        const res = await fetch('/api/audit');
        auditData = await res.json();
        renderAuditLog();
    } catch (e) {
        document.getElementById('auditTableBody').innerHTML = '<tr><td colspan="5" class="empty-state">Could not load audit log</td></tr>';
    }
}

function filterAction(btn, filter) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = filter;
    currentPage = 1;
    renderAuditLog();
}

function escHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

function renderAuditLog() {
    const tbody = document.getElementById('auditTableBody');
    const search = document.getElementById('auditSearch').value.toLowerCase();

    let filtered = auditData;

    if (currentFilter) {
        filtered = filtered.filter(e => e.action && e.action.startsWith(currentFilter));
    }

    if (search) {
        filtered = filtered.filter(e =>
            (e.action || '').toLowerCase().includes(search) ||
            (e.user || '').toLowerCase().includes(search) ||
            (e.ip || '').toLowerCase().includes(search) ||
            JSON.stringify(e.details || {}).toLowerCase().includes(search)
        );
    }

    const totalPages = Math.max(1, Math.ceil(filtered.length / perPage));
    if (currentPage > totalPages) currentPage = totalPages;
    const start = (currentPage - 1) * perPage;
    const pageItems = filtered.slice(start, start + perPage);

    if (pageItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No audit entries found</td></tr>';
        document.getElementById('auditPagination').innerHTML = '';
        return;
    }

    tbody.innerHTML = pageItems.map(entry => {
        const d = new Date(entry.timestamp);
        const ts = d.toLocaleDateString('nl-NL', {day:'2-digit',month:'2-digit',year:'numeric'}) + ' ' +
                   d.toLocaleTimeString('nl-NL', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
        const color = actionColors[entry.action] || 'var(--text-muted)';
        const details = entry.details && Object.keys(entry.details).length
            ? Object.entries(entry.details).map(([k,v]) => `<span style="color:var(--text-muted)">${escHtml(k)}:</span> <code>${escHtml(typeof v === 'object' ? JSON.stringify(v) : String(v))}</code>`).join(' &nbsp; ')
            : '<span style="color:var(--text-muted)">-</span>';
        return `<tr>
            <td style="font-size:12px;font-family:monospace;color:var(--text-secondary)">${escHtml(ts)}</td>
            <td>${escHtml(entry.user || '-')}</td>
            <td style="font-size:12px;font-family:monospace">${escHtml(entry.ip || '-')}</td>
            <td><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${color};margin-right:6px"></span>${escHtml(entry.action || '-')}</td>
            <td style="font-size:12px">${details}</td>
        </tr>`;
    }).join('');

    // Pagination
    const pagDiv = document.getElementById('auditPagination');
    if (totalPages <= 1) {
        pagDiv.innerHTML = `<span style="color:var(--text-muted);font-size:12px">${filtered.length} entries</span>`;
    } else {
        let html = '';
        if (currentPage > 1) html += `<button class="btn btn-sm" onclick="currentPage--;renderAuditLog()">Prev</button>`;
        html += `<span style="color:var(--text-secondary);font-size:12px;padding:4px 8px">Page ${currentPage}/${totalPages} (${filtered.length} entries)</span>`;
        if (currentPage < totalPages) html += `<button class="btn btn-sm" onclick="currentPage++;renderAuditLog()">Next</button>`;
        pagDiv.innerHTML = html;
    }
}

async function clearAuditLog() {
    showConfirm('Clear Audit Log', 'Are you sure you want to clear the entire audit log?', async () => {
        await apiCall('/api/audit/clear', 'POST');
        auditData = [];
        renderAuditLog();
    });
}

loadAuditLog();
</script>

<style>
.filter-btn.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(88, 166, 255, 0.1);
}
</style>
{% endblock %}
